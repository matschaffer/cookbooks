server {
  server_name api.doat.com api.prod.doat.com api.new.doat.com;
  listen 80;
  listen 81 default;
  listen 443 default;
  root /opt/doat/api/gondor;
  error_log <%= node[:nginx][:log_dir] %>/api.doat.com_error.log;
  access_log <%= node[:nginx][:log_dir] %>/api.doat.com_access.log;
  location ~ "\.svn" {
    deny all;
  }
  location / {
    index index.php;
    try_files $uri /index.php?r=$uri&$args;
  }
  location /favicon.ico {
  }
  location ~ .*\.php(/.*)?$ {
    include fastcgi_params;
    fastcgi_pass <%= if node[:php][:cgi][:bindaddress].start_with?("/")
                         "unix:" + node[:php][:cgi][:bindaddress]
                       else
                         node[:ipaddress] + ":" + node[:php][:cgi][:port]
                       end
                 %>;
    fastcgi_split_path_info ^(.+\.php)(.*)$;
    fastcgi_param SCRIPT_NAME     $fastcgi_script_name;
    fastcgi_param PATH_INFO       $fastcgi_path_info;
    fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass_header       Set-Cookie;
  }
}

